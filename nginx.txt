worker_processes 4;

events {

  worker_connections 1024;
}

http {
  # hide version on error pages
  server_tokens off;

  # security headers
  add_header X-Frame-Options SAMEORIGIN;
  add_header X-Content-Type-Options nosniff;
  add_header X-XSS-Protection "1; mode=block";
  add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload" always;

  # configuration containing list of application servers
  upstream app_servers {

    server ctfd:8000;
  }

  # redirect http to https
  server {
    listen 80 proxy_protocol;
    return 301 https://$host$request_uri;
  }

  server {
    listen 443 ssl proxy_protocol;
    server_name ctf.bsidesstpete.com;
    
    # enable oscp stapling + point to certificate chain
    ssl_stapling on;
    ssl_stapling_verify on;
    ssl_trusted_certificate /opt/CTFd/conf/nginx/fullchain.pem;

    # ssl stuff
    ssl_dhparam /opt/CTFd/conf/nginx/dhparam.pem;
    ssl_certificate /opt/CTFd/conf/nginx/cert.pem;
    ssl_certificate_key /opt/CTFd/conf/nginx/privkey.pem;
    ssl_prefer_server_ciphers on;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers "EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH EDH+aRSA HIGH";

    # session + request restrictions
    ssl_session_cache shared:SSL:50m;
    ssl_session_timeout 1d;
    ssl_buffer_size 16k;
    limit_req_zone $proxy_protocol_addr zone=mylimit:10m rate=10r/s;
    limit_conn_zone $proxy_protocol_addr zone=addr:10m;
    
    # buffer policy
    client_body_buffer_size 16K;
    client_header_buffer_size 1k;
    client_max_body_size 100M;
    large_client_header_buffers 2 1k;

    # connection limiting
    limit_req zone=mylimit burst=15;
    limit_conn addr 10;
    limit_req_status 429;

    # Handle Server Sent Events for Notifications
    location /events {

      proxy_pass http://app_servers;
      proxy_set_header Connection '';
      proxy_http_version 1.1;
      chunked_transfer_encoding off;
      proxy_buffering off;
      proxy_cache off;
      proxy_redirect off;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $proxy_protocol_addr;
      proxy_set_header X-Forwarded-For $proxy_protocol_addr;
      proxy_set_header X-Forwarded-Host $server_name;
    }

    # Proxy connections to the application servers
    location / {

      proxy_pass http://app_servers;
      proxy_redirect off;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $proxy_protocol_addr;
      proxy_set_header X-Forwarded-For $proxy_protocol_addr;
      proxy_set_header X-Forwarded-Host $server_name;
    }
  }
}